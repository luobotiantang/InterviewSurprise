# MQ相关

 - [为什么要使用消息队列?](#为什么要使用消息队列?)
 
 - [消息队列有什么优点及缺点?](#消息队列有什么优点及缺点?)
 
 ### 为什么要使用消息队列?
 
     解耦:
        解决了不同消息队列的各个系统之间调用的耦合问题.
        事例:一个系统对其他多个系统之间接口调用、去除调用、传不同的参数等，调用之间频繁的修改接口带来的严重耦合问题。
        MQ的Pub/Sub模型(发布订阅模型可以实现解耦)
     异步:
        解决了不同服务调用服务耗时的同步问题及A服务调用B服务(200ms)、调用C服务(400ms)、调用D服务(400ms)的耗时问题。
     削峰:
        避免大量用户调用A服务，A服务大量请求MySQL数据库(2000QPS)，MQ起到了削峰的作用，使请求到达A服务及数据库的请求
        没有那么多，使服务正常运行。   

 ### 消息队列有什么优点及缺点?
     
     优点:
        解耦、异步、削峰
     缺点:
        1、系统可用性降低(MQ服务挂掉的情况会导致的问题)
           如何保证消息队列的高可用性:
                RabbitMQ:
                    镜像集群模式下的MQ(每个节点上都有queue的全部数据)相比普通集群(只有一个节点有queue的全部数据，如果用户
                    请求其他节点必须经过此节点)更加高可用。
                    通过后台管理可以开启一个策略，使每个节点都有queue的全部数据，进而能够开启镜像集群模式。
                    问题不是分布式的(节点的queue的数据量比较大时导致queue存不下来的情况怎么办？)
                Kafka:
                    纯分布式的，数据分担到不同的机器上，有leader和follower进行选举机制(和集群不同的是集群中服务的数据是所有
                    的数据，数据没有分布；而分数式是数据分布到不同的机器上)
        
        2、考虑的问题变多了(消息重发的、消息丢失的情况、消息发送的顺序变了、消息服务挂了导致消息积累问题)        
        3、一致性问题(ABC服务成功而D失败，导致给用户的是成功其实数据是失败的)
            幂等性问题:
                例子:kafka消费者消费数据是有offset提交到zookeeper由zookeeper通知kafka的offset到哪了，但是消费者不是消费
                    完之后立马提交，消费者还没来得及提交就挂了，导致offset没有提交到zookeeper从而导致kafka把数据都推给消费
                    者，导致数据重发。
                那么怎么保证幂等性：
                    一条数据重复出现两次，这时如果数据库中有一条数据那么就能保证数据的幂等性。
                    解决办法:插入前进行校验过滤(如set)去重，数据库的唯一键约束也可以解决问题。
            数据丢失的问题:
                生产者--------网络传输中丢/MQ没有接收-------->MQ(MQ挂掉)-------->消费者(消费消息但是没有处理消费者挂了)              
                生产者丢数据:
                    1、消息异常会回滚，失败重试
                    2、confirm回调机制:
                            生产者发送数据到MQ，如果成功MQ会回调生产者一个回调方法，失败的话会重发消息，一般是用confirm机制
                            因为是异步形式吞吐量比较高。
                RQ弄丢数据:
                    消息持久化到磁盘上，但是还是有问题，MQ已经开启数据持久化机制，消息暂存到内存中还没来得及持久化到磁盘中MQ挂
                    了的情况。(这种机制是没法避免的会存在消息丢失)
                
                消费者丢失数据:
                    消费者打开autoAck机制，如果消费者消费消息并返回给MQ的autoAck说已经消费消息，但是消费者还没处理完此时消费
                    者挂了的情况                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
     

> reubenwang@foxmail.com
> 没事别找我，找我也不在！--我很忙🦆